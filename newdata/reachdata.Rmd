---
title: "rupertreach"
author: "A. Spence"
date: "2/22/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
'%!in%' <- function(x,y)!('%in%'(x,y))
```

# Rupert reaching data for PA grant

Let's recreate one of our python box plots to show we've loaded the data.

Testlink <http://spencelab.com>.

## Get started
```{r chunk1}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(ggpubr)
library(car)
library(Hmisc)
library(rstatix)
library(emmeans)
library(nlme)
library(stringr)
library(ggforce)

theme_update(plot.title = element_text(hjust = 0.5))
# maybe the plain BW background looks better than the grey stuff
# https://www.datanovia.com/en/lessons/combine-multiple-ggplots-into-a-figure/
#
theme_set(theme_bw())
#+
#    theme(legend.position = "top")
#  )
dfx <- read.csv("alldata_x.csv")
dfy <- read.csv("alldata_y.csv")
```

# prepare data, aggregate and stats
```{r prep}
dfx$treatment <- factor(dfx$treatment)
dfx$treatment <- relevel(dfx$treatment,'excite')
dfxt <- dfx %>% filter(time==0.4)
dfxt %>% group_by(treatment) %>%
  summarise(
    count = n(),
    mean = mean(x, na.rm = TRUE),
    sd = sd(x, na.rm = TRUE),
    median = median(x, na.rm = TRUE),
    IQR = IQR(x, na.rm = TRUE)
  )
# Plot it:
# choose comparisons to plot
# http://www.sthda.com/english/articles/32-r-graphics-essentials/132-plot-grouped-data-box-plot-bar-plot-and-more/
```

Do the 4 way analysis
```{r fourwayx}
my_comps <- list( c("control","inhib"),c("excite","control"),
                  c("excite","inhib"), c("control","norm"), c("excite","norm"), c("norm","inhib") )
dfxt %>% ggplot(aes(x = treatment, y = x,color = treatment))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
  #geom_sina(aes(color = treatment), show.legend = FALSE)+
  ylab("Max x") +
  xlab("Treatment") +
  coord_cartesian(ylim = c(-27, 55)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("Wrist Max x")+
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  # take out the global comparison, because it's implied that significant
  # since we are doing post hoc tests
  #stat_compare_means(aes(group = treatment), label =  "p.signif", label.y=30,
  #                   method='kruskal.test' ) # actually default is kruskal

#  stat_compare_means(aes(group = treatment), 
#                     method='kruskal.test' )

ggsave('xbox.pdf',width=2.5,height=3,units='in')
kruskal.test(x ~ treatment, data = dfxt)
pairwise.wilcox.test(dfxt$x, dfxt$treatment,
                 p.adjust.method = "BH")
```

```{r fourwayy}
dfy$treatment <- factor(dfy$treatment)
dfy$treatment <- relevel(dfy$treatment,'excite')
dfyt <- dfy %>% filter(time==0.4)
dfyt %>% group_by(treatment) %>%
  summarise(
    count = n(),
    mean = mean(y, na.rm = TRUE),
    sd = sd(y, na.rm = TRUE),
    median = median(y, na.rm = TRUE),
    IQR = IQR(y, na.rm = TRUE)
  )
# let's try to add the overbars and stars
# Statistical test
stat.test <- dfyt %>%
  kruskal.test(x=.$y, g=.$treatment) %>%
  add_significance()
stat.test
#stat.test <- tidy(stat.test %>% add_xy_position(x = "treatment"))
dfyt %>% ggplot(aes(x = treatment, y = y, color=treatment))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Max y") +
  xlab("Treatment") +
  coord_cartesian(ylim = c(-27, 75)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("Wrist Max y") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('ybox.pdf',width=2.5,height=3,units='in')
kruskal.test(y ~ treatment, data = dfyt)
pairwise.wilcox.test(dfyt$y, dfyt$treatment,
                 p.adjust.method = "BH")
```


Ok this code can be used with dropped norm level.
TODO: Add that drop...

```{r threewayold}
# TODO: DROP THE TREATMENT LEVEL NORM AND LET THIS PROCEED...
# Let's keep this code as is if we want to drop the norm level and proceed...
my_comps <- list( c("control","inhib"),c("excite","control"),
                  c("excite","inhib") )
dfxt %>% ggplot(aes(x = treatment, y = x,color = treatment))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
  #geom_sina(aes(color = treatment), show.legend = FALSE)+
  ylab("Max x") +
  xlab("Treatment") +
  coord_cartesian(ylim = c(-27, 35)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("Wrist Max x")+
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  # take out the global comparison, because it's implied that significant
  # since we are doing post hoc tests
  #stat_compare_means(aes(group = treatment), label =  "p.signif", label.y=30,
  #                   method='kruskal.test' ) # actually default is kruskal

#  stat_compare_means(aes(group = treatment), 
#                     method='kruskal.test' )

ggsave('xbox.pdf',width=2.5,height=3,units='in')
kruskal.test(x ~ treatment, data = dfxt)
pairwise.wilcox.test(dfxt$x, dfxt$treatment,
                 p.adjust.method = "BH")
```

y coord box plot

```{r prep2}
dfy$treatment <- factor(dfy$treatment)
dfy$treatment <- relevel(dfy$treatment,'excite')
dfyt <- dfy %>% filter(time==0.4)
dfyt %>% group_by(treatment) %>%
  summarise(
    count = n(),
    mean = mean(y, na.rm = TRUE),
    sd = sd(y, na.rm = TRUE),
    median = median(y, na.rm = TRUE),
    IQR = IQR(y, na.rm = TRUE)
  )
# let's try to add the overbars and stars
# Statistical test
stat.test <- dfyt %>%
  kruskal.test(x=.$y, g=.$treatment) %>%
  add_significance()
stat.test
#stat.test <- tidy(stat.test %>% add_xy_position(x = "treatment"))
dfyt %>% ggplot(aes(x = treatment, y = y, color=treatment))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Max y") +
  xlab("Treatment") +
  coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("Wrist Max y") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('ybox.pdf',width=2.5,height=3,units='in')
kruskal.test(y ~ treatment, data = dfyt)
pairwise.wilcox.test(dfyt$y, dfyt$treatment,
                 p.adjust.method = "BH")
```

Ok let's update with velocities, reach duration, deltaX, deltaY plots. Four way with norm

```{r velox4way}
md<-read_csv("reachfiles_generated_wvelocities.csv",col_types = cols(type=col_factor())) %>% filter(goodbad=="good")
md$type <- relevel(md$type,'control')
md$type <- relevel(md$type,'excite')
my_comps <- list( c("control","inhib"),c("excite","control"),
                  c("excite","inhib"), c("control","norm"), c("excite","norm"), c("norm","inhib") )
md %>% ggplot(aes(x = type, y = velx, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1,
               color = "#FC4E07", )+
ylab("X Velocity") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("X Velocity vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('xvel.pdf',width=2.5,height=3,units='in')
```

3 way Ok let's update with velocities, reach duration, deltaX, deltaY plots.

```{r velo}
md<-read_csv("reachfiles_generated_wvelocities.csv",col_types = cols(type=col_factor())) %>% filter(goodbad=="good")
md$type <- relevel(md$type,'control')
md$type <- relevel(md$type,'excite')
my_comps <- list( c("control","inhib"),c("excite","control"),
                  c("excite","inhib") )
md %>% ggplot(aes(x = type, y = velx, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("X Velocity") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("X Velocity vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('xvel3.pdf',width=2.5,height=3,units='in')
```

and now y four way

```{r veloy}
md %>% ggplot(aes(x = type, y = -vely, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Y Velocity") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("Y Velocity vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('yvel.pdf',width=2.5,height=3,units='in')
```


and now y

```{r veloy}
md %>% ggplot(aes(x = type, y = -vely, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Y Velocity") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("Y Velocity vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('yvel3.pdf',width=2.5,height=3,units='in')
```

and now dur 4 way

```{r velox}
md %>% ggplot(aes(x = type, y = rchdur, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Reach Duration (s)") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("Reach Duration vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('reachdur.pdf',width=2.5,height=3,units='in')
```

and now dur

```{r velox}
md %>% ggplot(aes(x = type, y = rchdur, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Reach Duration (s)") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("Reach Duration vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('reachdur3.pdf',width=2.5,height=3,units='in')
```


and now deltax

```{r veloy2}
md %>% ggplot(aes(x = type, y = dx, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Reach Distance (x)") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("Reach X Distance vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('xdistance.pdf',width=2.5,height=3,units='in')
```

and now deltax3way

```{r veloy2}
md %>% ggplot(aes(x = type, y = dx, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Reach Distance (x)") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("Reach X Distance vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('xdistance3.pdf',width=2.5,height=3,units='in')
```

and now deltay

```{r veloy3}
md %>% ggplot(aes(x = type, y = dy, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Reach Distance (y)") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140","#000000"))+
  ggtitle("Reach Y Distance vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('ydistance.pdf',width=2.5,height=3,units='in')
```


and now deltay3way

```{r veloy3}
md %>% ggplot(aes(x = type, y = dy, color=type))+ 
  #geom_boxplot(aes(color = treatment), show.legend = FALSE)+
  geom_violin(trim = FALSE,show.legend=FALSE) +
  geom_dotplot(
    binaxis='y', stackdir='center',
    color = "black", fill = "#999999",
    ) +
  stat_summary(
    fun.data="mean_sdl",  fun.args = list(mult=1), 
    geom = "pointrange", color = "#FC4E07", size = 0.4
    )+
  stat_summary(fun.y= mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", width=0.1, color = "#FC4E07", )+
ylab("Reach Distance (y)") +
  xlab("Treatment") +
  #coord_cartesian(ylim = c(-27, 60)) +
  scale_color_manual(values = c("#ED2024","#3953A4","#0C8140"))+
  ggtitle("Reach Y Distance vs Treatment") +
  stat_compare_means(comparisons=my_comps, label="p.signif") # + # default is Wilcox
  #stat_compare_means(aes(group = treatment), label =  "p.signif", 
  #                   method='kruskal.test',  hide.ns = TRUE )
ggsave('ydistance3.pdf',width=2.5,height=3,units='in')
```


